<!DOCTYPE html>
<html>
    <head>
        <title>vConestoga : Store Authentication</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">vConestoga</a></span>
                            </li>
                                                    <li>
                                <span><a href="vConestoga_536314119.html">vConestoga</a></span>
                            </li>
                                                    <li>
                                <span><a href="Projects_1091797023.html">Projects</a></span>
                            </li>
                                                    <li>
                                <span><a href="VARLab-Asset-Store_1124859959.html">VARLab Asset Store</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            vConestoga : Store Authentication
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Victor Barbosa Nogueira</span>, last modified by <span class='editor'> Nipun Grover</span> on Dec 09, 2024
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><style>[data-colorid=jvpx470xbc]{color:#36b37e} html[data-color-mode=dark] [data-colorid=jvpx470xbc]{color:#4cc994}[data-colorid=hc69nos1h1]{color:#ff5630} html[data-color-mode=dark] [data-colorid=hc69nos1h1]{color:#cf2600}[data-colorid=dejp8fnwg7]{color:#4c9aff} html[data-color-mode=dark] [data-colorid=dejp8fnwg7]{color:#004eb3}[data-colorid=n4mbwfzi7e]{color:#ff5630} html[data-color-mode=dark] [data-colorid=n4mbwfzi7e]{color:#cf2600}[data-colorid=lfeh0k90ft]{color:#ff5630} html[data-color-mode=dark] [data-colorid=lfeh0k90ft]{color:#cf2600}[data-colorid=gu6ub64kni]{color:#ff5630} html[data-color-mode=dark] [data-colorid=gu6ub64kni]{color:#cf2600}[data-colorid=simgun6zqy]{color:#ff5630} html[data-color-mode=dark] [data-colorid=simgun6zqy]{color:#cf2600}[data-colorid=pbm5xlr9zc]{color:#36b37e} html[data-color-mode=dark] [data-colorid=pbm5xlr9zc]{color:#4cc994}[data-colorid=oepsry3ycz]{color:#ff5630} html[data-color-mode=dark] [data-colorid=oepsry3ycz]{color:#cf2600}[data-colorid=wurk75wlhm]{color:#4c9aff} html[data-color-mode=dark] [data-colorid=wurk75wlhm]{color:#004eb3}[data-colorid=u9i6o7vi23]{color:#36b37e} html[data-color-mode=dark] [data-colorid=u9i6o7vi23]{color:#4cc994}[data-colorid=vv81lpxth4]{color:#4c9aff} html[data-color-mode=dark] [data-colorid=vv81lpxth4]{color:#004eb3}[data-colorid=di8f9p65hs]{color:#ff5630} html[data-color-mode=dark] [data-colorid=di8f9p65hs]{color:#cf2600}[data-colorid=sck9vmhq54]{color:#4c9aff} html[data-color-mode=dark] [data-colorid=sck9vmhq54]{color:#004eb3}[data-colorid=ooj2yji5vd]{color:#4c9aff} html[data-color-mode=dark] [data-colorid=ooj2yji5vd]{color:#004eb3}[data-colorid=lbku8sswsy]{color:#ff991f} html[data-color-mode=dark] [data-colorid=lbku8sswsy]{color:#e07a00}[data-colorid=dstma8fvkh]{color:#6554c0} html[data-color-mode=dark] [data-colorid=dstma8fvkh]{color:#503fab}[data-colorid=ffvb8xv2q4]{color:#36b37e} html[data-color-mode=dark] [data-colorid=ffvb8xv2q4]{color:#4cc994}[data-colorid=wgpoccubj0]{color:#ff5630} html[data-color-mode=dark] [data-colorid=wgpoccubj0]{color:#cf2600}[data-colorid=dzvo4bd473]{color:#ff5630} html[data-color-mode=dark] [data-colorid=dzvo4bd473]{color:#cf2600}</style>This article explains how the authentication for the Asset Store works. This page will explain how JSON Web Tokens (JWT) are produced and how they work for authentication. It also explains Passport.js and the strategies for authentication work. Finally, it will explain how authentication was implemented and how it works.</p><style type="text/css">/*<![CDATA[*/
div.rbtoc1748379754525 {padding: 0px;}
div.rbtoc1748379754525 ul {list-style: disc;margin-left: 0px;padding-left: ;}
div.rbtoc1748379754525 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class="toc-macro rbtoc1748379754525">
<ul class="toc-indentation">
<li><a href="#StoreAuthentication-AuthenticationFlow">üîÑ Authentication Flow</a></li>
<li><a href="#StoreAuthentication-JSONWebTokens(JWT)">ü™ô JSON Web Tokens (JWT)</a></li>
<li><a href="#StoreAuthentication-Passport.js">üõÇ Passport.js</a>
<ul class="toc-indentation">
<li><a href="#StoreAuthentication-AccessTokenStrategy(accessJwt)">ü™ô Access Token Strategy (accessJwt)</a></li>
<li><a href="#StoreAuthentication-RefreshTokenStrategy(refreshJwt)">ü™ô Refresh Token Strategy (refreshJwt)</a></li>
<li><a href="#StoreAuthentication-GoogleOauth">üá¨ Google Oauth</a></li>
</ul>
</li>
<li><a href="#StoreAuthentication-Middleware">ü§ö Middleware</a>
<ul class="toc-indentation">
<li><a href="#StoreAuthentication-checkAuthentication">checkAuthentication</a></li>
</ul>
</li>
<li><a href="#StoreAuthentication-RefreshTokenValidation">üîê Refresh Token Validation</a></li>
<li><a href="#StoreAuthentication-UsingPostmanwithJWT">üìÆ Using Postman with JWT</a></li>
</ul>
</div><h1 id="StoreAuthentication-AuthenticationFlow"><img class="emoticon emoticon-blue-star" data-emoji-id="1f504" data-emoji-shortname=":arrows_counterclockwise:" data-emoji-fallback="üîÑ" src="images/icons/emoticons/72/1f504.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Authentication Flow</h1><p>This is a summary of the authentication process</p><ol start="1"><li><p>User login</p></li><li><p>Issue access and refresh tokens</p></li><li><p>Save the refresh token to the User database</p></li><li><p>Send requests with the access token</p></li><li><p>When the access token expires</p><ol start="1"><li><p>whenever the user navigates on the website, a new request is send</p></li><li><p>the access token is invalid so the refresh token is checked in authMiddleware.js</p></li></ol></li><li><p>If they match:</p><ol start="1"><li><p>issue a new access token</p></li><li><p>Returns the new access token to the client</p></li></ol></li></ol><h1 id="StoreAuthentication-JSONWebTokens(JWT)"><img class="emoticon emoticon-blue-star" data-emoji-id="1fa99" data-emoji-shortname=":coin:" data-emoji-fallback="ü™ô" src="images/icons/emoticons/72/1fa99.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> JSON Web Tokens (JWT)</h1><h3 id="StoreAuthentication-WhatourJWTcontains:">What our JWT contains:</h3><ol start="1"><li><p><strong><span style="background-color: rgb(253,208,236);">Access Token</span></strong></p></li></ol><p style="margin-left: 30.0px;"><strong>1 - <span data-colorid="dzvo4bd473">Header</span></strong><span data-colorid="wgpoccubj0"> </span></p><p style="margin-left: 60.0px;">algorithm: HS256</p><p style="margin-left: 60.0px;">type: JWT</p><p style="margin-left: 30.0px;"><strong>2 - <span data-colorid="jvpx470xbc">Payload</span> </strong></p><p style="margin-left: 60.0px;">subject: _id,</p><p style="margin-left: 60.0px;">issuedAt: Math.floor(Date.now() / 1000),</p><p style="margin-left: 60.0px;">expiration: issuedAt + 10 minutes</p><p style="margin-left: 30.0px;"><strong>3 - <span data-colorid="wurk75wlhm">Verify Signature</span></strong> </p><p style="margin-left: 60.0px;">Created by encoding the Header and the Payload using Base64Url. After that, use the cryptographic algorithm specified in the header (HS256) with the ACCESS_SECRET to generate the signature.</p><ol start="2"><li><p><strong><span style="background-color: rgb(211,241,167);">Refresh Token</span></strong></p></li></ol><p style="margin-left: 30.0px;"><strong>1 - <span data-colorid="oepsry3ycz">Header</span></strong><span data-colorid="dstma8fvkh"> </span></p><p style="margin-left: 60.0px;">algorithm: RS256</p><p style="margin-left: 60.0px;">type: JWT</p><p style="margin-left: 30.0px;"><strong>2 - <span data-colorid="pbm5xlr9zc">Payload</span> </strong></p><p style="margin-left: 60.0px;">subject: _id,</p><p style="margin-left: 60.0px;">issuedAt: Math.floor(Date.now() / 1000),</p><p style="margin-left: 60.0px;">expiration: issuedAt + 30 days</p><p style="margin-left: 30.0px;"><strong>3 - <span data-colorid="ooj2yji5vd">Verify Signature</span></strong> </p><p style="margin-left: 60.0px;">Created by encoding the Header and the Payload using Base64Url. After that, use the cryptographic algorithm specified in the header (RS256) with the PRIVATE_KEY to generate the signature.</p><div class="panel" style="background-color: #EAE6FF;border-color: #998DD9;border-width: 1px;"><div class="panelContent" style="background-color: #EAE6FF;">
<p>After encoding all the 3 components, we concatenate them with a period '.' separator and add &ldquo;Bearer&rdquo; at the beginning. </p>
</div></div><p>Example:</p><blockquote><p>&ldquo;Bearer <span data-colorid="n4mbwfzi7e">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9</span>.<span data-colorid="u9i6o7vi23">eyJzdWIiOiI2NjZiMTExZDE5YjRmZTVhOTkwNjZiZjYiLCJpYXQiOjE3MTg4MDI1MjgxODQsImV4cCI6MTcxODgwMjYxNDU4NH0</span>.<span data-colorid="dejp8fnwg7">WUJr2UgmN1P9OKCMjRqAGz56WxO-sfcU3xVGhTmTlJ5V8XsiUNbTiavN31KeNu0E-rpyPxgka3fZMbdLZVcVRbgyMAioVdh0K36zAch0kj9nspj3ZipWhQNBYrNLY0R8I6jt9yoRNxQx2ptjw_EyH5I0Xfjdsy2Fr0dWkEIjQUpzwYw_UgJVLhW3kAVJ7wlpYFYb6BxqsmzIsOoewNKdk1t7NI1ep2NiSUWJslmCwl9bhVC9nRur9_JenUbMFkCh-D3RtVRQnysR8-iDXg22sOFcPf7n_EihbpB_9qSZMRHcmxPThgqy2hEQt4IoHnHTi2ogc-giwNGC207f_TIElGrrF02ghsjmaeMNzokuAh9Nedewxgj9LCfXf25uSZVo2aCFQeUQHwFwR4d-kxmKJwmPwt7796CI7nFwkfQ3MpfZVFCz64D1ur47MAul84bhw8QoNJqyRILpqOT_ZAi--Zqy7XYNdBngdsgzpxKLJNrMLnuRKIHL64-xTRraa8G-FqQ4NjvZxIJszikcTpg1sFjULEQo7jdwP0vAikv4x8383haj7ctgUu1Sl17rwF1JVDauFjRE0P4se1oKC27Q6xG5oBalWquzIporwd7qoz4YAvbjv_PKOrVpriMPhJ4nzQdzD_HYTS_4dCckl99cRU1D22WBxbM8Zu1iOume22E </span>&ldquo;</p></blockquote><p>You can see your JWT by going to the developer tools and then &lsquo;Application&rsquo; -&gt; &lsquo;Cookies&rsquo;:</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-155606.png" width="760" loading="lazy" src="attachments/1181581317/1181319200.png?width=760" data-image-src="attachments/1181581317/1181319200.png" data-height="388" data-width="1916" data-unresolved-comment-count="0" data-linked-resource-id="1181319200" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-155606.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="0253b886-a990-4165-8f5d-369842fa630a" data-media-type="file" /></span><h3 id="StoreAuthentication-Keys">Keys</h3><ul><li><p><strong>Private Key</strong>: it is used to sign(create) the JWT. Should be kept secret</p></li><li><p><strong>Public Key</strong>: used to verify the JWT. Can be shared </p></li></ul><p style="margin-left: 30.0px;">These keys are generated only once by running the file<em> </em><code>generateKeypair.js</code><em>  </em>located in <code>server/src/configs</code> </p><p style="margin-left: 30.0px;">The values of these keys are then stored in the file <code>.env</code> on the constants <code>PRIVATE_KEY</code> and <code>PUBLIC_KEY</code></p><div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" /><div class="confluence-information-macro-body"><p>Since the PRIVATE_KEY is the core component of the authentication system, the .env file and its content should be handled carefully. If by any means the PRIVATE_KEY gets compromised, run the generateKeypair.js file and update the PRIVATE_KEY value in the .env file</p></div></div><h1 id="StoreAuthentication-Passport.js"><img class="emoticon emoticon-blue-star" data-emoji-id="1f6c2" data-emoji-shortname=":passport_control:" data-emoji-fallback="üõÇ" src="images/icons/emoticons/72/1f6c2.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Passport.js</h1><h2 id="StoreAuthentication-AccessTokenStrategy(accessJwt)"><img class="emoticon emoticon-blue-star" data-emoji-id="1fa99" data-emoji-shortname=":coin:" data-emoji-fallback="ü™ô" src="images/icons/emoticons/72/1fa99.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Access Token Strategy (accessJwt)</h2><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Screen Shot 2024-07-05 at 13.45.49 PM.png" width="636" loading="lazy" src="attachments/1181581317/1207271433.png?width=636" data-image-src="attachments/1181581317/1207271433.png" data-height="368" data-width="636" data-unresolved-comment-count="0" data-linked-resource-id="1207271433" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Screen Shot 2024-07-05 at 13.45.49 PM.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="d753e701-49df-41ca-ac5e-3b9277e2913e" data-media-type="file" /></span><p><strong><span data-colorid="lfeh0k90ft">SecretOrKey</span></strong><span data-colorid="gu6ub64kni"> </span>:<strong> </strong>ACCESS_SECRET (String)</p><p><strong><span data-colorid="sck9vmhq54">Algorithm </span></strong>: HS256</p><p>Find the user <code>_id</code> in the database that matches <code>payload.sub</code></p><h2 id="StoreAuthentication-RefreshTokenStrategy(refreshJwt)"><img class="emoticon emoticon-blue-star" data-emoji-id="1fa99" data-emoji-shortname=":coin:" data-emoji-fallback="ü™ô" src="images/icons/emoticons/72/1fa99.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Refresh Token Strategy (refreshJwt)</h2><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Screen Shot 2024-07-05 at 13.49.25 PM.png" width="711" loading="lazy" src="attachments/1181581317/1207107589.png?width=711" data-image-src="attachments/1181581317/1207107589.png" data-height="373" data-width="711" data-unresolved-comment-count="0" data-linked-resource-id="1207107589" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Screen Shot 2024-07-05 at 13.49.25 PM.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="96e8f161-dcaa-4531-ad6b-57b85b33727e" data-media-type="file" /></span><p><strong><span data-colorid="simgun6zqy">SecretOrKey </span></strong>: PRIVATE_KEY (we use public, private keyset)</p><p><strong><span data-colorid="vv81lpxth4">Algorithm </span></strong>: RS256</p><p>Find the user <code>_id</code> in the database that matches <code>payload.sub</code>. If the user exists, it checks the user's refresh token in the database against the cookie value. If they are the same, call <code>done(null, user)</code> and return the user model retrieved from the database.</p><h2 id="StoreAuthentication-GoogleOauth"><img class="emoticon emoticon-blue-star" data-emoji-id="1f1ec" data-emoji-shortname=":regional_indicator_g:" data-emoji-fallback="üá¨" src="images/icons/emoticons/72/1f1ec.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Google Oauth</h2><h3 id="StoreAuthentication-1-Clientgoestoserver/src/routes/oauth.js">1 - Client goes to <code>server/src/routes/oauth.js</code></h3><p style="margin-left: 30.0px;">The server will then call the passport strategy &ldquo;google&rdquo; to authenticate the user.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-181216.png" width="720" loading="lazy" src="attachments/1181581317/1182138409.png?width=720" data-image-src="attachments/1181581317/1182138409.png" data-height="60" data-width="1180" data-unresolved-comment-count="0" data-linked-resource-id="1182138409" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-181216.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="7b9df92a-0716-4e74-8344-5809124c177b" data-media-type="file" /></span><h3 id="StoreAuthentication-2-Googlestrategy:server/src/configs/passport.js">2 - Google strategy: <code>server/src/configs/passport.js</code></h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-181333.png" width="700" loading="lazy" src="attachments/1181581317/1181319236.png?width=700" data-image-src="attachments/1181581317/1181319236.png" data-height="227" data-width="821" data-unresolved-comment-count="0" data-linked-resource-id="1181319236" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-181333.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="b73f8726-b067-4dd3-8ebf-96c383362222" data-media-type="file" /></span><p style="margin-left: 30.0px;">It receives the <code>clientID</code> and <code>clientSecret.</code> These values are generated by Google Cloud OAuth 2.0 Client IDs. Anyone with a Google account can create one. </p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-172039.png" width="760" loading="lazy" src="attachments/1181581317/1181384744.png?width=760" data-image-src="attachments/1181581317/1181384744.png" data-height="360" data-width="846" data-unresolved-comment-count="0" data-linked-resource-id="1181384744" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-172039.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="2b7bcf14-2d25-4d56-8879-d6a26d72016c" data-media-type="file" /></span><p style="margin-left: 30.0px;">After getting these values, the server will redirect the user to the Google Oauth page, where the user will log in with his account and authorize using his personal information. In our case, we are using <code>googleId</code> as a unique identifier for the user in the database.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-172338.png" width="760" loading="lazy" src="attachments/1181581317/1181286427.png?width=760" data-image-src="attachments/1181581317/1181286427.png" data-height="556" data-width="1131" data-unresolved-comment-count="0" data-linked-resource-id="1181286427" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-172338.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="38141020-b31a-443d-9d0c-be8180872008" data-media-type="file" /></span><p style="margin-left: 30.0px;">After logging in with your account, the callback function will be called. The user information will be retrieved as the <code>profile</code> variable. We then check the database to see if a user has that unique identifier. </p><p style="margin-left: 30.0px;">If a user already exists, we call <code>done(null, user)</code>, which sets the errors to null and returns the user model retrieved from the database.</p><p style="margin-left: 30.0px;">If there is no User with that Google ID, we create a new one and return that recently created User.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-173815.png" width="580" loading="lazy" src="attachments/1181581317/1182040097.png?width=580" data-image-src="attachments/1181581317/1182040097.png" data-height="434" data-width="740" data-unresolved-comment-count="0" data-linked-resource-id="1182040097" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-173815.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="fdc68e72-8390-4bec-81a6-fe7f98b833f6" data-media-type="file" /></span><p style="margin-left: 30.0px;"> You will be redirected to the <code>callbackURL</code> with the user object attached to the request header. </p><h3 id="StoreAuthentication-3-Callback:server/src/routes/oauth.js">3 - Callback: <code>server/src/routes/oauth.js</code></h3><p style="margin-left: 30.0px;">https://assetstore.vconestoga.com/api<span data-colorid="lbku8sswsy">/google/callback</span>:</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-175056.png" width="650" loading="lazy" src="attachments/1181581317/1181974563.png?width=650" data-image-src="attachments/1181581317/1181974563.png" data-height="178" data-width="1027" data-unresolved-comment-count="0" data-linked-resource-id="1181974563" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-175056.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="e92901c3-74bd-479f-801f-4e988125ce7e" data-media-type="file" /></span><p style="margin-left: 30.0px;">googleCallbackHandler()</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Screen Shot 2024-07-05 at 13.39.02 PM.png" width="760" loading="lazy" src="attachments/1181581317/1207042052.png?width=760" data-image-src="attachments/1181581317/1207042052.png" data-height="375" data-width="1045" data-unresolved-comment-count="0" data-linked-resource-id="1207042052" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Screen Shot 2024-07-05 at 13.39.02 PM.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="1c2e7cf2-8831-4187-8eb9-aa0bc686ba1a" data-media-type="file" /></span><p>The user object has been passed with the request and can be accessed through <code>req.user</code></p><p>We now create new access token and refresh token for the user. The JWTs will have the user ID as part of the <span data-colorid="ffvb8xv2q4">Payload. </span>And update user&rsquo;s refresh token in the database.</p><p>After that, the refresh token is sent as a cookie to the client. This cookie will be stored and used to reissue the access token.</p><h1 id="StoreAuthentication-Middleware"><img class="emoticon emoticon-blue-star" data-emoji-id="1f91a" data-emoji-shortname=":raised_back_of_hand:" data-emoji-fallback="ü§ö" src="images/icons/emoticons/72/1f91a.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Middleware</h1><h2 id="StoreAuthentication-checkAuthentication"><span data-colorid="hc69nos1h1">checkAuthentication</span></h2><p><em>server/src/middlewares/authMIddleware.js</em></p><p /><p>We use the <code>checkAuthentication</code> middleware for most API requests to verify if the user is authenticated. This middleware verifies the validity of the access token.</p><ol start="1"><li><p>Retrieve and split access/refresh tokens(remove Bearer) from the cookie (<code>req.cookies.accessToken</code>) </p></li><li><p>Verify token using <code>ACCESS_SECRET</code></p><ol start="1"><li><p>if the access token is <span data-colorid="di8f9p65hs">invalid</span>, verify the refresh token with <code>PUBLIC_KEY</code></p></li><li><p>get the user id from the database and check if the refresh token in the database matches the one in the cookie</p></li><li><p>if yes, issue a new access token</p></li></ol></li><li><p>Decode token and add authorization header for passport</p></li><li><p>Call <code>passport.authenticate()</code> with the <a data-card-appearance="inline" href="https://varlab-dev.atlassian.net/wiki/spaces/VCON/pages/edit-v2/1181581317#%F0%9F%AA%99-Access-Token-Strategy-(accessJwt)" rel="nofollow">https://varlab-dev.atlassian.net/wiki/spaces/VCON/pages/edit-v2/1181581317#%F0%9F%AA%99-Access-Token-Strategy-(accessJwt)</a> </p></li><li><p>If authentication is successful, attach the user object to the request</p></li><li><p>Call next()</p></li></ol><p /><h1 id="StoreAuthentication-RefreshTokenValidation"><img class="emoticon emoticon-blue-star" data-emoji-id="1f510" data-emoji-shortname=":closed_lock_with_key:" data-emoji-fallback="üîê" src="images/icons/emoticons/72/1f510.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Refresh Token Validation</h1><p><em><strong>server/src/routes/oauth.js</strong></em></p><p>When the access token is not valid, the client sends a request to <code>/refreshtoken</code>. If the refresh token is valid, it issues a new access token and responds with the new token.</p><ol start="1"><li><p>Retrieve and split a refresh token from the cookie <code>req.cookies.refreshToken</code></p></li><li><p>Verify token using <code>PUBLIC_KEY</code> </p></li><li><p>If the token is valid, attach the decoded token to <code>req.user</code> and add the authorization header for passport. If the token is not valid, clear the cookie and send a response with a 401 status.</p></li><li><p>Call <code>passport.authenticate()</code> with the <a data-card-appearance="inline" href="https://varlab-dev.atlassian.net/wiki/spaces/VCON/pages/edit-v2/1181581317#%F0%9F%AA%99-Refresh-Token-Strategy-(refreshJwt)" rel="nofollow">https://varlab-dev.atlassian.net/wiki/spaces/VCON/pages/edit-v2/1181581317#%F0%9F%AA%99-Refresh-Token-Strategy-(refreshJwt)</a> </p></li><li><p>If authentication is successful, issue a new access token</p></li><li><p>Send a response with the access token</p></li></ol><h1 id="StoreAuthentication-UsingPostmanwithJWT"><img class="emoticon emoticon-blue-star" data-emoji-id="1f4ee" data-emoji-shortname=":postbox:" data-emoji-fallback="üìÆ" src="images/icons/emoticons/72/1f4ee.png" width="16" height="16" data-emoticon-name="blue-star" alt="(blue star)"/> Using Postman with JWT</h1><h3 id="StoreAuthentication-1-LoginwithGoogleoauthorlocaladmin">1 - Login with Google oauth or local admin</h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-192855.png" width="170" loading="lazy" src="attachments/1181581317/1182072898.png?width=170" data-image-src="attachments/1181581317/1182072898.png" data-height="495" data-width="300" data-unresolved-comment-count="0" data-linked-resource-id="1182072898" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-192855.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="30938cae-c36f-45e2-b1a9-4d53cf5dea7f" data-media-type="file" /></span><h3 id="StoreAuthentication-2-Afterloggingin,pressf12.GotoApplication‚ÜíCookies.SelectthecookienamedrefreshToken.gotocookievalueandselectthecheckboxcalled‚ÄúShowURL-decoded‚Äù.CopytheentirevalueoftheJWT.">2 - After logging in, press f12. Go to Application &rarr; Cookies. Select the cookie named <code>refreshToken</code>. go to cookie value and select the check box called &ldquo;Show URL-decoded&rdquo;. Copy the entire value of the JWT.</h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240619-193513.png" width="760" loading="lazy" src="attachments/1181581317/1182105646.png?width=760" data-image-src="attachments/1181581317/1182105646.png" data-height="1034" data-width="1921" data-unresolved-comment-count="0" data-linked-resource-id="1182105646" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240619-193513.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="cd2d7e07-fbd4-4874-b817-76c512b35881" data-media-type="file" /></span><h3 id="StoreAuthentication-3-OpenPostman.TypetheURLyouwanttoaccess.GotoCookies.">3 - Open Postman. Type the URL you want to access. Go to Cookies. </h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240627-171925.png" width="760" loading="lazy" src="attachments/1181581317/1196982293.png?width=760" data-image-src="attachments/1181581317/1196982293.png" data-height="798" data-width="1299" data-unresolved-comment-count="0" data-linked-resource-id="1196982293" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240627-171925.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="e6337f1f-39ca-438d-8bfe-242861731ee1" data-media-type="file" /></span><h3 id="StoreAuthentication-4-Type‚Äúlocalhost:3000‚Äùandclickon‚ÄúAdddomain‚Äù">4 - Type &ldquo;localhost:3000&rdquo; and click on &ldquo;Add domain&rdquo;</h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240627-172137.png" width="760" loading="lazy" src="attachments/1181581317/1196097598.png?width=760" data-image-src="attachments/1181581317/1196097598.png" data-height="801" data-width="1295" data-unresolved-comment-count="0" data-linked-resource-id="1196097598" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240627-172137.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="04de1f5e-8162-443e-942e-f2e8d69f0dee" data-media-type="file" /></span><h3 id="StoreAuthentication-5-Click‚Äú+Addcookie‚Äù">5 - Click &ldquo;+Add cookie&rdquo;</h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240627-173602.png" width="760" loading="lazy" src="attachments/1181581317/1196458024.png?width=760" data-image-src="attachments/1181581317/1196458024.png" data-height="804" data-width="1295" data-unresolved-comment-count="0" data-linked-resource-id="1196458024" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240627-173602.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="04273a79-2dff-43ac-82a6-c688b733d319" data-media-type="file" /></span><h3 id="StoreAuthentication-6-Changethecookie'snamefrom‚ÄúCookie_1‚Äùto‚ÄúrefreshToken‚Äù.Changethevalueofthecookiefrom‚Äúvalue‚ÄùtotheJWTyoucopiedfromthebrowserStep2">6 - Change the cookie's name from &ldquo;Cookie_1&rdquo; to &ldquo;refreshToken&rdquo;. Change the value of the cookie from &ldquo;value&rdquo; to the JWT you copied from the browser  <a href="https://varlab-dev.atlassian.net/wiki/spaces/VCON/pages/edit-v2/1181581317#2---After-logging-in%2C-press-f12.-Go-to-Application-%E2%86%92-Cookies.-Select-the-cookie-named-%E2%80%98token%E2%80%99.-go-to-cookie-value-and-select-the-check-box-called-%E2%80%9CShow-URL-decoded%E2%80%9D.-Copy-the-entire-value-of-the-JWT." rel="nofollow">Step 2</a> </h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240627-174441.png" width="760" loading="lazy" src="attachments/1181581317/1196785686.png?width=760" data-image-src="attachments/1181581317/1196785686.png" data-height="802" data-width="1294" data-unresolved-comment-count="0" data-linked-resource-id="1196785686" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240627-174441.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="772e8044-d8fb-4c40-8c27-5656bee1a734" data-media-type="file" /></span><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20241007-151901.png" width="760" loading="lazy" src="attachments/1181581317/1385299976.png?width=760" data-image-src="attachments/1181581317/1385299976.png" data-height="778" data-width="1025" data-unresolved-comment-count="0" data-linked-resource-id="1385299976" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20241007-151901.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="dcff244c-0c92-40c5-b736-b06662b5b801" data-media-type="file" /></span><p /><h3 id="StoreAuthentication-7-Clicksave">7 - Click save</h3><h3 id="StoreAuthentication-8-Closethecookiespop-up">8 - Close the cookies pop-up</h3><h3 id="StoreAuthentication-9-Sendtherequest">9 - Send the request</h3><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20240627-175038.png" width="760" loading="lazy" src="attachments/1181581317/1196621860.png?width=760" data-image-src="attachments/1181581317/1196621860.png" data-height="802" data-width="1298" data-unresolved-comment-count="0" data-linked-resource-id="1196621860" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20240627-175038.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1181581317" data-linked-resource-container-version="16" data-media-id="03bb7228-bc7f-4a8a-8b85-db647980e26a" data-media-type="file" /></span><p>Make sure that you are using a valid (not expired) JWT.</p><p>Notice that the Cookie was added to the header</p><p />
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181319200.png">image-20240619-155606.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181384744.png">image-20240619-172039.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181286427.png">image-20240619-172338.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1182007350.png">image-20240619-172459.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181351979.png">image-20240619-173700.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1182040097.png">image-20240619-173815.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181384756.png">image-20240619-174505.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181974563.png">image-20240619-175056.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181515837.png">image-20240619-175158.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1182138409.png">image-20240619-181216.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181319236.png">image-20240619-181333.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1182072898.png">image-20240619-192855.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181646925.png">image-20240619-193115.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1182105646.png">image-20240619-193513.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181941822.png">image-20240619-193832.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181581388.png">image-20240619-194007.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1181450295.png">image-20240619-194101.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196982293.png">image-20240627-171925.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196097598.png">image-20240627-172137.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196458024.png">image-20240627-173602.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1195966497.png">image-20240627-173930.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196654625.png">image-20240627-174305.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1195966503.png">image-20240627-174437.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196785686.png">image-20240627-174441.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1195933735.png">image-20240627-174727.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196523557.png">image-20240627-174858.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1196621860.png">image-20240627-175038.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207042052.png">Screen Shot 2024-07-05 at 13.39.02 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207271427.png">image-20240705-174508.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207271433.png">Screen Shot 2024-07-05 at 13.45.49 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207107589.png">Screen Shot 2024-07-05 at 13.49.25 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1206910999.png">Screen Shot 2024-07-05 at 14.43.29 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207107606.png">Screen Shot 2024-07-05 at 14.43.47 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207369770.png">Screen Shot 2024-07-05 at 14.44.15 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207435274.png">Screen Shot 2024-07-05 at 14.45.27 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1207238692.png">Screen Shot 2024-07-05 at 15.05.18 PM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1221623811.png">Screen Shot 2024-07-15 at 10.11.13 AM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1221361668.png">Screen Shot 2024-07-15 at 10.11.13 AM.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1384808457.png">image-20241007-151843.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1181581317/1385299976.png">image-20241007-151901.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 27, 2025 21:02</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
